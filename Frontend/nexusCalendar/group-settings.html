<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Group Settings</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Jost', sans-serif;
    }

    #back-btn {
      background-color: var(--primary-color, #6799b2);
      color: var(--text-color, #fff);
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 20px;
    }

    #back-btn:hover {
      opacity: 0.9;
    }

    section {
      margin-bottom: 30px;
    }

    h1, h2 {
      font-weight: 600;
    }

    input, select, textarea, button {
      font-family: inherit;
      margin-top: 5px;
    }

    #group-form, #group-details {
      display: none;
    }

    .group-item {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <button id="back-btn">‚Üê Back to Calendar</button>
    <h1>Group Settings</h1>

    <section>
      <p><strong>User ID:</strong> <code id="user-id-display">Loading...</code></p>

  <div>
        <label>Join Group by ID:
          <input type="text" id="join-group-id" placeholder="Enter group ID" />
          <button id="join-group-btn">Join</button>
        </label>
      </div>

      <label>Joined Groups:
        <select id="group-selector">
          <option selected disabled>None</option>
        </select>
      </label><br>

      <button id="create-group-toggle">Create New Group</button>
      <div id="group-form"></div>

    
    </section>

    <div id="group-details">
      <section>
        <h2>Group Info</h2>
        <label>Group Name: <input type="text" id="group-name" placeholder="Enter group name" /></label><br><br>
        <label>Group Color: <input type="color" id="group-color" value="#6799b2" /></label><br>
      </section>

      <section>
        <h2>Members</h2>
        <ul id="member-list"></ul>
        <label>Invite By User ID:
  <input type="text" id="invite-user-id" placeholder="User ID" />
  <button id="invite-user-btn">Send Invite</button>
</label>

      </section>

      <section>
        <h2>Calendar Preferences</h2>
        <label>Default View:
          <select>
            <option>Day</option>
            <option>Week</option>
            <option selected>Month</option>
          </select>
        </label><br>
        <label>Time Zone: <input type="text" placeholder="e.g., CST" /></label>
      </section>
      <button id="submit-group">Submit Group</button>

      <div id="user-groups-list"></div>
    </div>
  </div>

  <script>
    const display = document.getElementById('user-id-display');
    const userId = localStorage.getItem('nexusUserId');
    display.textContent = userId || 'Not logged in';

    document.getElementById('back-btn').addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    document.getElementById('create-group-toggle').addEventListener('click', () => {
      const form = document.getElementById('group-form');
      const details = document.getElementById('group-details');
      const show = form.style.display === 'none';
      form.style.display = show ? 'block' : 'none';
      details.style.display = show ? 'block' : 'none';
    });

    document.getElementById('submit-group').addEventListener('click', async () => {
      const groupName = document.getElementById('group-name').value;
      const creatorId = localStorage.getItem('nexusUserId');
      const inviteIdsRaw = document.getElementById('invite-ids').value;

      if (!groupName || !creatorId) {
        alert("Missing group name or user ID");
        return;
      }

      const response = await fetch('http://localhost:3001/create-group', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ groupName, creatorId })
      });

      const data = await response.json();

      if (response.ok) {
        alert(`Group "${groupName}" created!`);

        const memberList = document.getElementById('member-list');
        memberList.innerHTML = '';  // Clear previous
        const li = document.createElement('li');
        li.textContent = `${localStorage.getItem('nexusName') || 'You'} (admin)`;
        memberList.appendChild(li);


        const groupId = data.groupId;
        await loadGroupMembers(groupId);

        const inviteIds = inviteIdsRaw.split(',').map(id => id.trim()).filter(Boolean);

        for (const receiverId of inviteIds) {
          await fetch('http://localhost:3001/invite-to-group', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groupId, senderId: creatorId, receiverId })
          });
        }

        alert(`Invited ${inviteIds.length} user(s) to the group.`);
      } else {
        alert(`Error: ${data.error}`);
      }
    });

   async function loadUserGroups() {
  const userId = localStorage.getItem("nexusUserId");
  if (!userId) return alert("Not logged in.");

  try {
    const response = await fetch(`http://localhost:3001/users/${userId}/groups`);
    const result = await response.json();

    const selector = document.getElementById("group-selector");
    selector.innerHTML = '<option selected disabled>None</option>';

    result.groups.forEach(group => {
      const option = document.createElement("option");
      option.value = group.groupId;
      option.textContent = group.name;
      selector.appendChild(option);
    });
  } catch (err) {
    console.error("Error loading groups:", err);
    alert("Failed to fetch groups.");
  }
}


    async function createGroup() {
      const groupName = prompt("Enter group name:");
      const creatorId = localStorage.getItem("nexusUserId");
      if (!groupName || !creatorId) return;

      try {
        const response = await fetch("http://localhost:3001/create-group", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ groupName, creatorId })
        });

        const data = await response.json();
        if (response.ok) {
          alert("Group created!");
          loadUserGroups();
        } else {
          alert(data.error || "Could not create group.");
        }
      } catch (err) {
        console.error("Error creating group:", err);
        alert("Error.");
      }
    }

  document.getElementById('join-group-btn').addEventListener('click', async () => {
      const groupId = document.getElementById('join-group-id').value;
      const userId = localStorage.getItem('nexusUserId');

      if (!groupId || !userId) return alert("Missing info");

      try {
        const res = await fetch('http://localhost:3001/accept-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, groupId })
        });

        const data = await res.json();
        if (res.ok) {
          alert("Joined group!");
          loadUserGroups();
        } else {
          alert(data.error || "Failed to join group");
        }
      } catch (err) {
        console.error("Join group error:", err);
        alert("Join failed.");
      }
    });
  async function loadGroupMembers(groupId) {
  const list = document.getElementById('member-list');
  list.innerHTML = '';

  try {
    const membersSnapshot = await fetch(`http://localhost:3001/groups/${groupId}/members`);
    const membersData = await membersSnapshot.json();

    if (!Array.isArray(membersData.members)) {
      list.innerHTML = '<li>No members found.</li>';
      return;
    }

    membersData.members.forEach(member => {
      const li = document.createElement('li');
      const name = member.name || member.userId || 'Unknown';

      li.textContent = `${name}${member.isCreator ? ' (admin)' : ''}`;
      list.appendChild(li);
    });

  } catch (err) {
    console.error("Failed to load members:", err);
    list.innerHTML = '<li>Error loading members</li>';
  }
}

document.getElementById('group-selector').addEventListener('change', async (e) => {
  const groupId = e.target.value;
  const selectedOption = e.target.options[e.target.selectedIndex];
  const groupName = selectedOption.textContent;

  document.getElementById('group-details').style.display = 'block';

  const nameInput = document.getElementById('group-name');
  nameInput.value = groupName;
  nameInput.disabled = false;

  document.getElementById('submit-group').style.display = 'none';
  if (!document.getElementById('save-group')) {
    const saveBtn = document.createElement('button');
    saveBtn.id = 'save-group';
    saveBtn.textContent = 'Save Changes';
    saveBtn.addEventListener('click', async () => {
      const updatedName = document.getElementById('group-name').value;
      const updatedColor = document.getElementById('group-color').value;
      const userId = localStorage.getItem("nexusUserId");

      await fetch(`http://localhost:3001/groups/${groupId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: updatedName, color: updatedColor, userId })
      });

      alert('Group updated!');
      await loadUserGroups();
    });
    document.getElementById('group-details').appendChild(saveBtn);
  }

  await loadGroupMembers(groupId);
});

document.getElementById('invite-user-btn').addEventListener('click', async () => {
  const groupId = document.getElementById('group-selector').value;
  const adderId = localStorage.getItem('nexusUserId');
  const targetUserId = document.getElementById('invite-user-id').value.trim();

  if (!groupId || !adderId || !targetUserId) {
    alert("Missing group or user ID.");
    return;
  }

  try {
    const res = await fetch('http://localhost:3001/add-to-group', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ groupId, adderId, targetUserId })
    });

    const data = await res.json();

    if (res.ok) {
      alert("User added to group.");
      await loadGroupMembers(groupId);
      document.getElementById('invite-user-id').value = '';
    } else {
      alert(data.error || "Failed to add user.");
    }
  } catch (err) {
    console.error("Add user error:", err);
    alert("Error adding user.");
  }
});


   loadUserGroups();
  </script>
</body>
</html>
